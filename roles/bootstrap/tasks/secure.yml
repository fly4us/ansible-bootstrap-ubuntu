---
- name: Setup fail2ban
  template:
    src=fail2ban/jail.local
    dest=/etc/fail2ban/jail.local
  notify:
    - restart fail2ban

- name: Setup sshd port
  lineinfile:
    dest=/etc/ssh/sshd_config
    regexp="^Port"
    line="Port {{ sshd_port }}"
    state=present
  notify:
    - restart ssh

- name: Disallow password authentication
  lineinfile:
    dest=/etc/ssh/sshd_config
    regexp="^PasswordAuthentication"
    line="PasswordAuthentication no"
    state=present
  notify:
    - restart ssh

- name: Disallow root SSH access
  lineinfile:
    dest=/etc/ssh/sshd_config
    regexp="^PermitRootLogin"
    line="PermitRootLogin no"
    state=present
  notify:
    - restart ssh

- name: Disallow SSH GSS API authentication
  lineinfile:
    dest=/etc/ssh/sshd_config
    regexp="^GSSAPIAuthentication"
    line="GSSAPIAuthentication no"
    state=present
  notify:
    - restart sshd

- name: Delete /etc/sudoers.d/ files
  shell:
    rm -f /etc/sudoers.d/*

- name: Install packages
  apt:
    pkg=ufw
    state=installed

- name: Setup ufw {{ sshd_port }}/tcp
  shell:
    ufw allow {{ sshd_port }}/tcp

- name: Enable ufw
  shell:
    echo 'y' | ufw enable

- name: Delete root password
  shell:
    passwd -d root
